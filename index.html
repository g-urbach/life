<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Life Story ‚Ä¢ Cloud</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    button { padding: 12px 20px; margin: 6px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    .primary { background: #10b981; color: white; }
    .secondary { background: #3b82f6; color: white; }
    .entry { border: 1px solid #e2e8f0; padding: 16px; margin-bottom: 16px; border-radius: 8px; background: #f8fafc; }
    .story { white-space: pre-wrap; background: #f1f5f9; padding: 20px; border-radius: 8px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>‚ù§Ô∏è My Life Story ‚Ä¢ Cloud Edition</h1>
  <p><strong>Share this page with your family ‚Äî they only need their email + password.</strong></p>

  <!-- Auth -->
  <div style="background:#f0f9ff;padding:15px;border-radius:8px;margin:20px 0;">
    <input id="email" placeholder="Email" style="width:48%;padding:8px;">
    <input id="password" type="password" placeholder="Password" style="width:48%;padding:8px;">
    <button onclick="signUp()" class="secondary">Sign Up</button>
    <button onclick="signIn()" class="primary">Sign In</button>
    <button onclick="signOut()" class="secondary">Sign Out</button>
    <span id="userStatus" style="margin-left:15px;font-weight:bold;"></span>
  </div>

  <button onclick="tellMeMore()" class="primary">üé§ Tell Me More (Voice)</button>
  <button onclick="newVoiceMemo()">üéôÔ∏è New Voice Memo</button>
  <button onclick="typeEntry()">‚å®Ô∏è New Typed Entry</button>
  <button onclick="generateStory()">üìñ Generate My Story</button>
  <button onclick="continueStory()">üîÑ Continue My Story</button>
  <button onclick="exportData()">‚¨áÔ∏è Export JSON</button>
  <button onclick="importData()">‚¨ÜÔ∏è Import JSON</button>
  <button onclick="clearMyData()" style="background:#ef4444;color:white;">Delete My Data</button>

  <div id="reminder" style="margin:15px 0;font-weight:bold;color:#10b981;"></div>
  <div class="log" id="log"></div>
  <div id="storyArea"></div>

  <script>
    // === REPLACE THESE WITH YOUR REAL VALUES ===


const SUPABASE_URL = 'YOUR_SUPABASE_URL';  
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';  
const GEMINI_KEY = 'YOUR_GEMINI_KEY';

    let supabaseClient = null;
    let currentUser = null;
    let entries = [];
    let recognition = null;
    const categories = ["Childhood","Family","Education","Career","Relationships","Adventures","Challenges","Reflections","Other"];

    function initSupabase() {
      if (!SUPABASE_URL.includes('supabase.co') || SUPABASE_ANON_KEY.length < 50) {
        alert('Please replace the SUPABASE_URL and SUPABASE_ANON_KEY at the top of the code!');
        return;
      }
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      checkAuth();
    }

    function logMessage(message) {
      const logDiv = document.getElementById('log');
      const entryDiv = document.createElement('div');
      entryDiv.className = 'entry';
      entryDiv.textContent = `${new Date().toLocaleString()}: ${message}`;
      logDiv.appendChild(entryDiv);
      logDiv.scrollTop = logDiv.scrollHeight; // Auto-scroll to bottom
    }

    async function checkAuth() {
      logMessage('Checking authentication status');
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      if (error) {
        logMessage('Error checking auth: ' + error.message);
        return;
      }
      currentUser = user;
      if (user) {
        document.getElementById('userStatus').textContent = `Logged in as ${user.email}`;
        logMessage('User authenticated');
        await loadEntries();
        dailyReminder();
      } else {
        document.getElementById('userStatus').textContent = 'Not logged in';
        entries = [];
        document.getElementById('log').innerHTML = '';
        document.getElementById('storyArea').innerHTML = '';
        logMessage('No user authenticated');
      }
    }

    async function signUp() {
      logMessage('Starting sign up');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) {
        logMessage('Email or password missing');
        return;
      }
      try {
        const { data, error } = await supabaseClient.auth.signUp({ email, password });
        if (error) throw error;
        logMessage('Sign up successful. Check your email for verification link.');
      } catch (error) {
        logMessage('Sign up error: ' + error.message);
      }
    }

    async function signIn() {
      logMessage('Starting sign in');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) {
        logMessage('Email or password missing');
        return;
      }
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;
        currentUser = data.user;
        logMessage('Sign in successful');
        await checkAuth();
      } catch (error) {
        logMessage('Sign in error: ' + error.message);
      }
    }

    async function signOut() {
      logMessage('Starting sign out');
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        currentUser = null;
        logMessage('Signed out successfully');
        await checkAuth();
      } catch (error) {
        logMessage('Sign out error: ' + error.message);
      }
    }

    async function loadEntries() {
      if (!currentUser) return;
      logMessage('Loading entries');
      try {
        const { data, error } = await supabaseClient.from('life_entries').select('*').eq('user_id', currentUser.id).order('timestamp', { ascending: false });
        if (error) throw error;
        entries = data;
        logMessage(`Loaded ${entries.length} entries`);
        displayEntries();
      } catch (error) {
        logMessage('Error loading entries: ' + error.message + ' (Check if table exists and RLS is set up in Supabase)');
      }
    }

    function displayEntries() {
      const logDiv = document.getElementById('log');
      logDiv.innerHTML = ''; // Clear previous content
      entries.forEach(entry => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'entry';
        let content = `<strong>${entry.category || 'Other'}</strong> (${new Date(entry.timestamp).toLocaleDateString()})<br>`;
        if (entry.question) content += `<em>Question: ${entry.question}</em><br>`;
        content += `${entry.answer || ''}`;
        if (entry.photo) content += `<br>Photo: ${entry.photo}`;
        if (entry.audio) content += `<br>Audio: ${entry.audio}`;
        entryDiv.innerHTML = content;
        logDiv.appendChild(entryDiv);
      });
    }

    async function addEntry(category, answer, question = null, photo = null, audio = null) {
      if (!currentUser) return logMessage('Must be logged in to add entry');
      logMessage('Adding new entry');
      const insertData = {
        user_id: currentUser.id,
        category: category || 'Other',
        answer: answer,
        question: question,
        photo: photo,
        audio: audio
      };
      const { error } = await supabaseClient.from('life_entries').insert(insertData);
      if (error) {
        logMessage('Error adding entry: ' + error.message);
      } else {
        logMessage('Entry added successfully');
        await loadEntries();
      }
    }

    function initRecognition() {
      if (recognition) return;
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        logMessage('Speech recognition not supported in this browser');
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onerror = event => logMessage('Voice recognition error: ' + event.error);
      recognition.onend = () => logMessage('Voice recognition ended');
    }

    async function tellMeMore() {
      if (!GEMINI_KEY) return logMessage('Gemini API key is missing - set it in the code');
      if (!currentUser) return logMessage('Must be logged in');
      initRecognition();
      if (!recognition) return;
      logMessage('Generating thoughtful question via Gemini');
      const entrySummaries = entries.map(e => (e.question ? e.question + ': ' : '') + (e.answer || '')).join('\n');
      const prompt = `Based on these life story entries: ${entrySummaries || 'No previous entries'}\nGenerate one thoughtful question to elicit more details about the person's life. Question only.`;
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        if (!response.ok) throw new Error(`Gemini API failed with status ${response.status}`);
        const data = await response.json();
        const question = data.candidates[0].content.parts[0].text.trim();
        logMessage(`Question: ${question}`);
        alert(question); // Display question (could use speech synthesis in future)
        recognition.onresult = event => {
          const answer = event.results[0][0].transcript;
          logMessage(`Voice response captured: ${answer}`);
          addEntry('Other', answer, question);
        };
        recognition.start();
        logMessage('Listening for voice response...');
      } catch (error) {
        logMessage('Error generating question: ' + error.message);
      }
    }

    function newVoiceMemo() {
      if (!currentUser) return logMessage('Must be logged in');
      initRecognition();
      if (!recognition) return;
      recognition.onresult = event => {
        const answer = event.results[0][0].transcript;
        logMessage(`Voice memo captured: ${answer}`);
        const category = prompt('Category for this memo: ' + categories.join(', ')) || 'Other';
        addEntry(category, answer);
      };
      recognition.start();
      logMessage('Listening for voice memo...');
    }

    function typeEntry() {
      if (!currentUser) return logMessage('Must be logged in');
      const category = prompt('Category: ' + categories.join(', ')) || 'Other';
      const answer = prompt('Enter your text:');
      if (answer) addEntry(category, answer);
    }

    async function generateStory() {
      if (!GEMINI_KEY) return logMessage('Gemini API key is missing - set it in the code');
      if (!currentUser) return logMessage('Must be logged in');
      if (entries.length === 0) return logMessage('No entries to generate story from');
      logMessage('Generating life story via Gemini');
      const categorizedEntries = categories.map(cat => {
        const catTexts = entries.filter(e => e.category === cat).map(e => (e.question ? e.question + ': ' : '') + (e.answer || '')).join('\n');
        return catTexts ? `${cat}:\n${catTexts}` : '';
      }).filter(Boolean).join('\n\n');
      const prompt = `Create a cohesive, engaging narrative life story from these categorized entries. Use first-person perspective:\n${categorizedEntries}`;
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        if (!response.ok) throw new Error(`Gemini API failed with status ${response.status}`);
        const data = await response.json();
        const story = data.candidates[0].content.parts[0].text;
        document.getElementById('storyArea').innerHTML = `<div class="story"><h2>My Life Story</h2><pre>${story}</pre></div>`;
        logMessage('Life story generated successfully');
      } catch (error) {
        logMessage('Error generating story: ' + error.message);
      }
    }

    async function continueStory() {
      if (!GEMINI_KEY) return logMessage('Gemini API key is missing - set it in the code');
      if (!currentUser) return logMessage('Must be logged in');
      const storyDiv = document.getElementById('storyArea');
      const currentStory = storyDiv.textContent.trim();
      if (!currentStory) return logMessage('Generate a story first to continue');
      logMessage('Continuing life story via Gemini');
      const prompt = `Continue this life story in a cohesive, engaging way. Add more details or next chapters based on any available entries: ${currentStory}`;
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        if (!response.ok) throw new Error(`Gemini API failed with status ${response.status}`);
        const data = await response.json();
        const continuation = data.candidates[0].content.parts[0].text;
        storyDiv.innerHTML = `<div class="story"><h2>My Life Story (Continued)</h2><pre>${currentStory}\n\n${continuation}</pre></div>`;
        logMessage('Life story continued successfully');
      } catch (error) {
        logMessage('Error continuing story: ' + error.message);
      }
    }

    function exportData() {
      if (!currentUser) return logMessage('Must be logged in');
      const data = { entries };
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentUser.email.replace(/@/g, '_')}_life_story.json`;
      a.click();
      URL.revokeObjectURL(url);
      logMessage('Data exported as JSON');
    }

    function importData() {
      if (!currentUser) return logMessage('Must be logged in');
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = async e => {
        try {
          const file = e.target.files[0];
          const text = await file.text();
          const data = JSON.parse(text);
          logMessage(`Importing ${data.entries.length} entries`);
          for (const entry of data.entries) {
            await addEntry(entry.category, entry.answer, entry.question, entry.photo, entry.audio);
          }
          logMessage('Data imported successfully');
        } catch (error) {
          logMessage('Error importing data: ' + error.message);
        }
      };
      input.click();
    }

    async function clearMyData() {
      if (!currentUser) return logMessage('Must be logged in');
      if (!confirm('Are you sure you want to delete all your data? This cannot be undone.')) return;
      logMessage('Deleting all entries');
      const { error } = await supabaseClient.from('life_entries').delete().eq('user_id', currentUser.id);
      if (error) {
        logMessage('Error deleting data: ' + error.message);
      } else {
        logMessage('All data deleted');
        await loadEntries();
      }
    }

    function dailyReminder() {
      // Simple reminder; could be enhanced to check last entry date
      document.getElementById('reminder').textContent = "Don't forget to add something to your life story today!";
    }

    // Init
    initSupabase();
    supabaseClient.auth.onAuthStateChange((event, session) => {
      logMessage(`Auth state changed: ${event}`);
      checkAuth();
    });
  </script>
</body>
</html>