<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Life Story</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    button { padding: 12px 20px; margin: 6px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    .primary { background: #10b981; color: white; }
    .secondary { background: #3b82f6; color: white; }
    .entry { border: 1px solid #e2e8f0; padding: 16px; margin-bottom: 16px; border-radius: 8px; background: #f8fafc; }
    .story { white-space: pre-wrap; background: #f1f5f9; padding: 20px; border-radius: 8px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>â¤ï¸ My Life Story</h1>
  <p><strong>Share this page with your family â€” they only need their email + password.</strong></p>

  <div style="background:#f0f9ff;padding:15px;border-radius:8px;margin:20px 0;">
    <input id="email" placeholder="Email" style="width:48%;padding:8px;">
    <input id="password" type="password" placeholder="Password" style="width:48%;padding:8px;">
    <button onclick="signUp()" class="secondary">Sign Up</button>
    <button onclick="signIn()" class="primary">Sign In</button>
    <button onclick="signOut()" class="secondary">Sign Out</button>
    <span id="userStatus" style="margin-left:15px;font-weight:bold;"></span>
  </div>

  <button onclick="letsTalk()" class="primary">Lets talk :)</button>
  <button onclick="newVoiceMemo()">ğŸ™ï¸ New Voice Memo</button>
  <button onclick="typeEntry()">âŒ¨ï¸ New Typed Entry</button>
  <button onclick="generateStory()">ğŸ“– Generate My Story</button>
  <button onclick="continueStory()">ğŸ”„ Continue My Story</button>
  <button onclick="showChronologicalRecord()">ğŸ“‹ Chronological Record</button>
  <button onclick="clearMyData()" style="background:#ef4444;color:white;">Delete My Data</button>
  <button id="stopTalk" onclick="stopConversation()" style="display:none;background:#ef4444;color:white;">â›” Stop Talking</button>

  <div id="reminder" style="margin:15px 0;font-weight:bold;color:#10b981;"></div>
  <div class="log" id="log"></div>
  <div id="storyArea"></div>
  <div id="timelineArea" style="display:none;margin-top:30px;"></div>

  <script>
    const SUPABASE_URL = 'https://zygetlpgjkpyiyjquhfp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5Z2V0bHBnamtweWl5anF1aGZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTk1NjcsImV4cCI6MjA4NjczNTU2N30.ZKb4tcjKGOU2XkRrEad3GxKLeRtKwdrdPlNwB9yvDeA';

    let supabaseClient = null;
    let currentUser = null;
    let entries = [];
    let recognition = null;
    let isConversing = false;
    const categories = ["Childhood","Family","Education","Career","Relationships","Adventures","Challenges","Reflections","Other"];

    function initSupabase() {
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      checkAuth();
    }

    function logMessage(message) {
      console.log('LOG: ' + message);
      const logDiv = document.getElementById('log');
      const entryDiv = document.createElement('div');
      entryDiv.className = 'entry';
      entryDiv.textContent = `${new Date().toLocaleString()}: ${message}`;
      logDiv.appendChild(entryDiv);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function checkAuth() {
      logMessage('Checking auth');
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      currentUser = user;
      if (user) {
        document.getElementById('userStatus').textContent = `Logged in as ${user.email}`;
        await loadEntries();
        dailyReminder();
      } else {
        document.getElementById('userStatus').textContent = 'Not logged in';
        entries = [];
        document.getElementById('log').innerHTML = '';
        document.getElementById('storyArea').innerHTML = '';
        document.getElementById('timelineArea').style.display = 'none';
      }
    }

    async function signUp() { /* unchanged */ }
    async function signIn() { /* unchanged */ }
    async function signOut() { /* unchanged */ }

    async function loadEntries() {
      if (!currentUser) return;
      try {
        const { data, error } = await supabaseClient.from('life_entries').select('*').eq('user_id', currentUser.id).order('timestamp', { ascending: false });
        if (!error) entries = data;
      } catch (e) { logMessage('Load error: ' + e.message); }
    }

    async function addEntry(category, answer, question = null) {
      if (!currentUser) return;
      const { error } = await supabaseClient.from('life_entries').insert({
        user_id: currentUser.id,
        category: category || 'Other',
        answer,
        question,
        timestamp: new Date().toISOString()
      });
      if (!error) await loadEntries();
    }

    function initRecognition() {
      if (recognition) return;
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return logMessage('Speech not supported');
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = true;
      recognition.maxAlternatives = 1;

      recognition.onerror = e => {
        logMessage('Voice error: ' + e.error);
        if (isConversing && (e.error === 'no-speech' || e.error === 'aborted')) {
          setTimeout(() => recognition.start(), 600);
        }
      };

      recognition.onend = () => {
        if (isConversing) setTimeout(() => recognition.start(), 1000);
      };
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        speechSynthesis.speak(new SpeechSynthesisUtterance(text));
      }
    }

    async function callAI(prompt) {
      console.log('Calling AI:', prompt);
      const { data, error } = await supabaseClient.functions.invoke('ai-proxy', {
        body: { prompt }
      });
      console.log('AI response:', data, error);
      if (error) throw error;
      if (data.error) throw new Error(data.error.message);
      return data.choices[0].message.content.trim();
    }

    async function letsTalk() {
      if (!currentUser) return logMessage('Must log in');
      isConversing = true;
      document.getElementById('stopTalk').style.display = 'inline-block';
      logMessage('Starting conversation...');
      await askNextQuestion();
    }

    async function askNextQuestion() {
      if (!isConversing) return;
      const summaries = entries.map(e => (e.question ? e.question + ': ' : '') + (e.answer || '')).join('\n');
      const prompt = `From these entries: ${summaries || 'None yet'}\nAsk one very short question (1 sentence, max 15 words) to learn more. Be warm. Question only.`;
      try {
        const question = await callAI(prompt);
        logMessage(`Question: ${question}`);
        speak(question);

        initRecognition();
        if (!recognition) return;

        recognition.onresult = async e => {
          let text = '';
          for (let i = e.resultIndex; i < e.results.length; i++) {
            text += e.results[i][0].transcript;
          }
          if (text.trim()) {
            logMessage(`You said: ${text}`);
            await addEntry('Other', text, question);
            recognition.stop();
            setTimeout(askNextQuestion, 1200);
          }
        };

        recognition.start();
        logMessage('Listening...');
      } catch (e) {
        logMessage('AI error: ' + e.message);
        stopConversation();
      }
    }

    function stopConversation() {
      isConversing = false;
      document.getElementById('stopTalk').style.display = 'none';
      if (recognition) recognition.abort();
      speak('Conversation ended. Thanks!');
      logMessage('Conversation ended');
    }

    // (keep newVoiceMemo, typeEntry, generateStory, continueStory, showChronologicalRecord, clearMyData, dailyReminder as before)

    initSupabase();
    supabaseClient.auth.onAuthStateChange(() => checkAuth());
  </script>
</body>
</html>