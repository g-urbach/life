<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Life Story</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    button { padding: 12px 20px; margin: 6px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .primary { background: #10b981; color: white; }
    .secondary { background: #3b82f6; color: white; }
    .entry { border: 1px solid #e2e8f0; padding: 16px; margin-bottom: 16px; border-radius: 8px; background: #f8fafc; }
    .story { white-space: pre-wrap; background: #f1f5f9; padding: 20px; border-radius: 8px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>‚ù§Ô∏è My Life Story</h1>
  <p><strong>Share this page with your family ‚Äî they only need their email + password.</strong></p>

  <div style="background:#f0f9ff;padding:15px;border-radius:8px;margin:20px 0;">
    <input id="email" placeholder="Email" style="width:48%;padding:8px;">
    <input id="password" type="password" placeholder="Password" style="width:48%;padding:8px;">
    <button id="signUpBtn" onclick="signUp()" class="secondary">Sign Up</button>
    <button id="signInBtn" onclick="signIn()" class="primary">Sign In</button>
    <button onclick="signOut()" class="secondary">Sign Out</button>
    <button id="clearSessionBtn" onclick="clearSession()" style="background:#f59e0b;color:white;display:none;">Clear Session & Retry</button>
    <span id="userStatus" style="margin-left:15px;font-weight:bold;"></span>
  </div>

  <button onclick="letsTalk()" class="primary">Lets talk :)</button>
  <button onclick="newVoiceMemo()">üéôÔ∏è New Voice Memo</button>
  <button onclick="typeEntry()">‚å®Ô∏è New Typed Entry</button>
  <button onclick="generateStory()">üìñ Generate My Story</button>
  <button onclick="continueStory()">üîÑ Continue My Story</button>
  <button onclick="showChronologicalRecord()">üìã Chronological Record</button>
  <button onclick="clearMyData()" style="background:#ef4444;color:white;">Delete My Data</button>
  <button id="stopTalk" onclick="stopConversation()" style="display:none;background:#ef4444;color:white;">‚õî Stop Talking</button>

  <div id="reminder" style="margin:15px 0;font-weight:bold;color:#10b981;"></div>
  <div class="log" id="log"></div>
  <div id="storyArea"></div>
  <div id="timelineArea" style="display:none;margin-top:30px;"></div>

  <script>
    const SUPABASE_URL = 'https://zygetlpgjkpyiyjquhfp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5Z2V0bHBnamtweWl5anF1aGZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTk1NjcsImV4cCI6MjA4NjczNTU2N30.ZKb4tcjKGOU2XkRrEad3GxKLeRtKwdrdPlNwB9yvDeA';

    let supabaseClient = null;
    let currentUser = null;
    let entries = [];
    let recognition = null;
    let isConversing = false;
    let isAuthInProgress = false;
    const categories = ["Childhood","Family","Education","Career","Relationships","Adventures","Challenges","Reflections","Other"];

    function initSupabase() {
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: true, autoRefreshToken: true, storage: localStorage }
      });
      supabaseClient.auth.getSession().then(() => checkAuth());
    }

    function logMessage(message) {
      console.log('LOG: ' + message);
      const logDiv = document.getElementById('log');
      const entryDiv = document.createElement('div');
      entryDiv.className = 'entry';
      entryDiv.textContent = `${new Date().toLocaleString()}: ${message}`;
      logDiv.appendChild(entryDiv);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function checkAuth() {
      if (isAuthInProgress) return;
      isAuthInProgress = true;
      logMessage('Checking auth');
      const { data: { user } } = await supabaseClient.auth.getUser();
      currentUser = user;
      if (user) {
        document.getElementById('userStatus').textContent = `Logged in as ${user.email}`;
        document.getElementById('clearSessionBtn').style.display = 'none';
        await loadEntries();
        dailyReminder();
      } else {
        document.getElementById('userStatus').textContent = 'Not logged in';
        document.getElementById('clearSessionBtn').style.display = 'inline-block';
      }
      isAuthInProgress = false;
    }

    async function signIn() {
      if (isAuthInProgress) return logMessage('Already signing in...');
      isAuthInProgress = true;
      document.getElementById('signInBtn').disabled = true;
      logMessage('Signing in...');

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;

        currentUser = data.user;
        logMessage('Sign in successful!');

        await supabaseClient.auth.refreshSession();
        await new Promise(r => setTimeout(r, 1500));
        await checkAuth();
      } catch (error) {
        let msg = 'Sign in failed. Try again.';
        if (error.message.includes('Invalid login credentials')) msg = 'Email or password not recognized.';
        if (error.message.includes('Email not confirmed')) msg = 'Email not confirmed ‚Äî check inbox/spam.';
        logMessage(msg);
      } finally {
        document.getElementById('signInBtn').disabled = false;
        isAuthInProgress = false;
      }
    }

    function clearSession() {
      logMessage('Clearing session...');
      localStorage.clear();
      indexedDB.deleteDatabase('supabase');
      supabaseClient.auth.signOut().then(() => checkAuth());
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      await checkAuth();
    }

    async function loadEntries() {
      if (!currentUser) return;
      const { data } = await supabaseClient.from('life_entries').select('*').eq('user_id', currentUser.id).order('timestamp', { ascending: false });
      entries = data || [];
    }

    async function addEntry(category, answer, question = null) {
      if (!currentUser) return;
      await supabaseClient.from('life_entries').insert({
        user_id: currentUser.id,
        category: category || 'Other',
        answer,
        question,
        timestamp: new Date().toISOString()
      });
      await loadEntries();
    }

    function initRecognition() {
      if (recognition) return;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return logMessage('Speech not supported');
      recognition = new SR();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onerror = e => logMessage('Voice error: ' + e.error);
      recognition.onend = () => {
        if (isConversing) setTimeout(() => { if (recognition) recognition.start(); }, 800);
      };
    }

    function speak(text) {
      if ('speechSynthesis' in window) speechSynthesis.speak(new SpeechSynthesisUtterance(text));
    }

    async function callAI(prompt) {
      for (let attempt = 1; attempt <= 4; attempt++) {
        try {
          const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', { body: { prompt } });
          if (error) throw error;
          if (data.error) throw new Error(data.error.message);
          return data.choices[0].message.content.trim();
        } catch (error) {
          if (error.message.includes('429') && attempt < 4) {
            logMessage(`Rate limit hit ‚Äî waiting ${attempt * 8} seconds...`);
            await new Promise(r => setTimeout(r, attempt * 8000));
            continue;
          }
          throw error;
        }
      }
      throw new Error('Rate limit persistent');
    }

    async function letsTalk() {
      if (!currentUser) return logMessage('Must log in');
      isConversing = true;
      document.getElementById('stopTalk').style.display = 'inline-block';
      logMessage('Starting conversation...');
      await askNextQuestion();
    }

    async function askNextQuestion() {
      if (!isConversing) return;
      const summaries = entries.map(e => (e.question ? e.question + ': ' : '') + (e.answer || '')).join('\n');
      const prompt = `From these entries: ${summaries || 'None yet'}\nAsk one very short question (max 12 words). Be warm. Question only.`;

      try {
        const question = await callAI(prompt);
        logMessage(`Question: ${question}`);
        speak(question);

        initRecognition();
        recognition.onresult = async e => {
          let text = '';
          for (let i = e.resultIndex; i < e.results.length; i++) text += e.results[i][0].transcript;
          if (text.trim()) {
            logMessage(`You said: ${text}`);
            await addEntry('Other', text, question);
            recognition.stop();
            setTimeout(askNextQuestion, 8000); // generous pause
          }
        };
        if (!recognition.active) recognition.start();
        logMessage('Listening...');
      } catch (e) {
        logMessage('AI temporarily unavailable ‚Äî try again in a minute.');
        stopConversation();
      }
    }

    function stopConversation() {
      isConversing = false;
      document.getElementById('stopTalk').style.display = 'none';
      if (recognition) recognition.abort();
      speak('Conversation ended. Thanks!');
      logMessage('Conversation ended');
    }

    // Other functions (newVoiceMemo, typeEntry, generateStory, continueStory, etc.) are unchanged from your last working version

    initSupabase();
    supabaseClient.auth.onAuthStateChange(() => checkAuth());
  </script>
</body>
</html>