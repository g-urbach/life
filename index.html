<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Life Story</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    button { padding: 12px 20px; margin: 6px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    .primary { background: #10b981; color: white; }
    .secondary { background: #3b82f6; color: white; }
    .entry { border: 1px solid #e2e8f0; padding: 16px; margin-bottom: 16px; border-radius: 8px; background: #f8fafc; }
    .story { white-space: pre-wrap; background: #f1f5f9; padding: 20px; border-radius: 8px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>‚ù§Ô∏è My Life Story</h1>
  <p><strong>Share this page with your family ‚Äî they only need their email + password.</strong></p>

  <!-- Auth -->
  <div style="background:#f0f9ff;padding:15px;border-radius:8px;margin:20px 0;">
    <input id="email" placeholder="Email" style="width:48%;padding:8px;">
    <input id="password" type="password" placeholder="Password" style="width:48%;padding:8px;">
    <button onclick="signUp()" class="secondary">Sign Up</button>
    <button onclick="signIn()" class="primary">Sign In</button>
    <button onclick="signOut()" class="secondary">Sign Out</button>
    <button id="clearSessionBtn" onclick="clearSession()" style="background:#f59e0b;color:white;display:none;">Clear Session & Retry</button>
    <span id="userStatus" style="margin-left:15px;font-weight:bold;"></span>
  </div>

  <button onclick="letsTalk()" class="primary">Lets talk :)</button>
  <button onclick="newVoiceMemo()">üéôÔ∏è New Voice Memo</button>
  <button onclick="typeEntry()">‚å®Ô∏è New Typed Entry</button>
  <button onclick="generateStory()">üìñ Generate My Story</button>
  <button onclick="continueStory()">üîÑ Continue My Story</button>
  <button onclick="showChronologicalRecord()">üìã Chronological Record</button>
  <button onclick="clearMyData()" style="background:#ef4444;color:white;">Delete My Data</button>
  <button id="stopTalk" onclick="stopConversation()" style="display:none;background:#ef4444;color:white;">‚õî Stop Talking</button>

  <div id="reminder" style="margin:15px 0;font-weight:bold;color:#10b981;"></div>
  <div class="log" id="log"></div>
  <div id="storyArea"></div>
  <div id="timelineArea" style="display:none;margin-top:30px;"></div>

  <script>
    const SUPABASE_URL = 'https://zygetlpgjkpyiyjquhfp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5Z2V0bHBnamtweWl5anF1aGZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTk1NjcsImV4cCI6MjA4NjczNTU2N30.ZKb4tcjKGOU2XkRrEad3GxKLeRtKwdrdPlNwB9yvDeA';

    let supabaseClient = null;
    let currentUser = null;
    let entries = [];
    let recognition = null;
    let isConversing = false;
    const categories = ["Childhood","Family","Education","Career","Relationships","Adventures","Challenges","Reflections","Other"];

    function initSupabase() {
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      // Auto-refresh session on load to fix stale sessions
      supabaseClient.auth.refreshSession().then(() => checkAuth());
    }

    function logMessage(message) {
      console.log('LOG: ' + message);
      const logDiv = document.getElementById('log');
      const entryDiv = document.createElement('div');
      entryDiv.className = 'entry';
      entryDiv.textContent = `${new Date().toLocaleString()}: ${message}`;
      logDiv.appendChild(entryDiv);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function checkAuth() {
      logMessage('Checking auth');
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      currentUser = user;
      if (user) {
        document.getElementById('userStatus').textContent = `Logged in as ${user.email}`;
        document.getElementById('clearSessionBtn').style.display = 'none';
        await loadEntries();
        dailyReminder();
      } else {
        document.getElementById('userStatus').textContent = 'Not logged in';
        entries = [];
        document.getElementById('log').innerHTML = '';
        document.getElementById('storyArea').innerHTML = '';
        document.getElementById('timelineArea').style.display = 'none';
        document.getElementById('clearSessionBtn').style.display = 'inline-block';
      }
    }

    async function signUp() {
      logMessage('Starting sign up');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) {
        logMessage('Please enter email and password');
        return;
      }

      try {
        const { data, error } = await supabaseClient.auth.signUp({ email, password });
        if (error) throw error;
        logMessage('Sign up successful! Check your email for confirmation link.');
      } catch (error) {
        let msg = 'Sign up failed. Please try again.';
        if (error.message.includes('duplicate') || error.message.includes('already registered')) {
          msg = 'Email already registered. Try signing in.';
        } else if (error.message.includes('password')) {
          msg = 'Password too weak (min 6 characters).';
        } else if (error.message.includes('email')) {
          msg = 'Invalid email format.';
        }
        logMessage(msg);
      }
    }

    async function signIn() {
      logMessage('Starting sign in');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) {
        logMessage('Please enter email and password');
        return;
      }

      try {
        console.log('DEBUG: Attempting signInWithPassword with', { email });
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        console.log('DEBUG: signIn response', { data, error });

        if (error) throw error;

        currentUser = data.user;
        logMessage('Sign in successful!');

        // Wait for session to settle, then refresh and check
        await new Promise(r => setTimeout(r, 1000));
        await supabaseClient.auth.refreshSession();
        await new Promise(r => setTimeout(r, 1000));
        logMessage('Session synced ‚Äî final check...');
        await checkAuth();
      } catch (error) {
        console.log('Sign in failed:', error);
        let msg = 'Sign in failed. Try again.';
        if (error.message.includes('Invalid login credentials') || error.message.includes('not found')) {
          msg = 'Email or password not recognized.';
        } else if (error.message.includes('Email not confirmed')) {
          msg = 'Email not confirmed ‚Äî check inbox/spam.';
        } else if (error.message.includes('AbortError') || error.message.includes('Lock broken')) {
          msg = 'Session issue. Click "Clear Session & Retry" below.';
        }
        logMessage(msg);
      }
    }

    function clearSession() {
      logMessage('Clearing old session...');
      localStorage.clear();
      indexedDB.deleteDatabase('supabase');
      supabaseClient.auth.signOut().then(() => {
        logMessage('Session cleared. Please sign in again.');
        checkAuth();
      });
    }

    async function signOut() {
      logMessage('Signing out');
      await supabaseClient.auth.signOut();
      currentUser = null;
      logMessage('Signed out successfully');
      await checkAuth();
    }

    async function loadEntries() {
      if (!currentUser) return;
      try {
        const { data, error } = await supabaseClient.from('life_entries').select('*').eq('user_id', currentUser.id).order('timestamp', { ascending: false });
        if (!error) entries = data;
      } catch (e) {
        logMessage('Load error: ' + e.message);
      }
    }

    async function addEntry(category, answer, question = null) {
      if (!currentUser) return;
      const { error } = await supabaseClient.from('life_entries').insert({
        user_id: currentUser.id,
        category: category || 'Other',
        answer,
        question,
        timestamp: new Date().toISOString()
      });
      if (!error) await loadEntries();
    }

    function initRecognition() {
      if (recognition) return;
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return logMessage('Speech not supported');
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = true;
      recognition.maxAlternatives = 1;

      recognition.onerror = e => {
        logMessage('Voice error: ' + e.error);
        if (isConversing && (e.error === 'no-speech' || e.error === 'aborted')) {
          setTimeout(() => recognition.start(), 600);
        }
      };

      recognition.onend = () => {
        if (isConversing) setTimeout(() => recognition.start(), 1000);
      };
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        speechSynthesis.speak(new SpeechSynthesisUtterance(text));
      }
    }

    async function callAI(prompt) {
      console.log('Calling AI:', prompt);
      const { data, error } = await supabaseClient.functions.invoke('ai-proxy', {
        body: { prompt }
      });
      console.log('AI response:', data, error);
      if (error) throw error;
      if (data.error) throw new Error(data.error.message);
      return data.choices[0].message.content.trim();
    }

    async function letsTalk() {
      if (!currentUser) return logMessage('Must log in');
      isConversing = true;
      document.getElementById('stopTalk').style.display = 'inline-block';
      logMessage('Starting conversation...');
      await askNextQuestion();
    }

    async function askNextQuestion() {
      if (!isConversing) return;
      const summaries = entries.map(e => (e.question ? e.question + ': ' : '') + (e.answer || '')).join('\n');
      const prompt = `From these entries: ${summaries || 'None yet'}\nAsk one very short question (1 sentence, max 15 words) to learn more. Be warm. Question only.`;
      try {
        const question = await callAI(prompt);
        logMessage(`Question: ${question}`);
        speak(question);

        initRecognition();
        if (!recognition) return;

        recognition.onresult = async e => {
          let text = '';
          for (let i = e.resultIndex; i < e.results.length; i++) {
            text += e.results[i][0].transcript;
          }
          if (text.trim()) {
            logMessage(`You said: ${text}`);
            await addEntry('Other', text, question);
            recognition.stop();
            setTimeout(askNextQuestion, 1200);
          }
        };

        recognition.start();
        logMessage('Listening...');
      } catch (e) {
        logMessage('AI error: ' + e.message);
        stopConversation();
      }
    }

    function stopConversation() {
      isConversing = false;
      document.getElementById('stopTalk').style.display = 'none';
      if (recognition) recognition.abort();
      speak('Conversation ended. Thanks!');
      logMessage('Conversation ended');
    }

    function newVoiceMemo() {
      if (!currentUser) return logMessage('Must be logged in');
      initRecognition();
      if (!recognition) return;
      recognition.onresult = event => {
        const answer = event.results[0][0].transcript;
        logMessage(`Voice memo: ${answer}`);
        const category = prompt('Category: ' + categories.join(', ')) || 'Other';
        addEntry(category, answer);
      };
      recognition.start();
      logMessage('Listening for memo...');
    }

    function typeEntry() {
      if (!currentUser) return logMessage('Must be logged in');
      const category = prompt('Category: ' + categories.join(', ')) || 'Other';
      const answer = prompt('Enter text:');
      if (answer) addEntry(category, answer);
    }

    async function generateStory() {
      if (!currentUser) return logMessage('Must be logged in');
      if (entries.length === 0) return logMessage('No entries');
      document.getElementById('timelineArea').style.display = 'none';
      logMessage('Generating story');
      const categorizedEntries = categories.map(cat => {
        const catTexts = entries.filter(e => e.category === cat).map(e => (e.question ? e.question + ': ' : '') + (e.answer || '')).join('\n');
        return catTexts ? `${cat}:\n${catTexts}` : '';
      }).filter(Boolean).join('\n\n');
      const aiPrompt = `Create a cohesive, engaging narrative life story from these categorized entries. Use first-person perspective:\n${categorizedEntries}`;
      try {
        const story = await callAI(aiPrompt);
        document.getElementById('storyArea').innerHTML = `<div class="story"><h2>My Life Story</h2><pre>${story}</pre></div>`;
        logMessage('Story generated');
      } catch (error) {
        logMessage('Error generating story: ' + error.message);
      }
    }

    async function continueStory() {
      if (!currentUser) return logMessage('Must be logged in');
      const storyDiv = document.getElementById('storyArea');
      const currentStory = storyDiv.textContent.trim();
      if (!currentStory) return logMessage('Generate story first');
      document.getElementById('timelineArea').style.display = 'none';
      logMessage('Continuing story');
      const aiPrompt = `Continue this life story cohesively. Add details or chapters based on entries: ${currentStory}`;
      try {
        const continuation = await callAI(aiPrompt);
        storyDiv.innerHTML = `<div class="story"><h2>My Life Story (Continued)</h2><pre>${currentStory}\n\n${continuation}</pre></div>`;
        logMessage('Story continued');
      } catch (error) {
        logMessage('Error continuing story: ' + error.message);
      }
    }

    function showChronologicalRecord() {
      document.getElementById('storyArea').innerHTML = '';
      const area = document.getElementById('timelineArea');
      area.style.display = 'block';
      const sorted = [...entries].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      let html = '<h2>üìã Chronological Record</h2>';
      sorted.forEach(entry => {
        const date = new Date(entry.timestamp).toLocaleString();
        html += `<div class="entry"><strong>${date}</strong> - <strong>${entry.category || 'Other'}</strong><br>`;
        if (entry.question) html += `<em>Question: ${entry.question}</em><br>`;
        html += `${entry.answer || ''}</div>`;
      });
      area.innerHTML = html;
    }

    async function clearMyData() {
      if (!currentUser) return logMessage('Must be logged in');
      if (!confirm('Sure? This deletes everything permanently.')) return;
      logMessage('Deleting data');
      const { error } = await supabaseClient.from('life_entries').delete().eq('user_id', currentUser.id);
      if (error) {
        logMessage('Error deleting: ' + error.message);
      } else {
        logMessage('Data deleted');
        await loadEntries();
      }
    }

    function dailyReminder() {
      document.getElementById('reminder').textContent = "Don't forget to add to your life story today!";
    }

    // Init
    initSupabase();
    supabaseClient.auth.onAuthStateChange(() => checkAuth());
  </script>
</body>
</html>