<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Life Story</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
    }
    button {
      padding: 12px 20px;
      margin: 6px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .primary { background: #10b981; color: white; }
    .secondary { background: #3b82f6; color: white; }
    .entry {
      border: 1px solid #e2e8f0;
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 8px;
      background: #f8fafc;
    }
    .story {
      white-space: pre-wrap;
      background: #f1f5f9;
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>‚ù§Ô∏è My Life Story</h1>
  <p><strong>Share this page with your family ‚Äî they only need their email + password.</strong></p>

  <!-- Auth -->
  <div style="background:#f0f9ff;padding:15px;border-radius:8px;margin:20px 0;">
    <input id="email" placeholder="Email" style="width:48%;padding:8px;">
    <input id="password" type="password" placeholder="Password" style="width:48%;padding:8px;">
    <button id="signUpBtn" onclick="signUp()" class="secondary">Sign Up</button>
    <button id="signInBtn" onclick="signIn()" class="primary">Sign In</button>
    <button onclick="signOut()" class="secondary">Sign Out</button>
    <button id="clearSessionBtn" onclick="clearSession()" style="background:#f59e0b;color:white;display:none;">Clear Session & Retry</button>
    <span id="userStatus" style="margin-left:15px;font-weight:bold;"></span>
  </div>

  <button onclick="letsTalk()" class="primary">Lets talk :)</button>
  <button onclick="newVoiceMemo()">üéôÔ∏è New Voice Memo</button>
  <button onclick="typeEntry()">‚å®Ô∏è New Typed Entry</button>
  <button onclick="generateStory()">üìñ Generate My Story</button>
  <button onclick="continueStory()">üîÑ Continue My Story</button>
  <button onclick="showChronologicalRecord()">üìã Chronological Record</button>
  <button onclick="clearMyData()" style="background:#ef4444;color:white;">Delete My Data</button>
  <button id="stopTalk" onclick="stopConversation()" style="display:none;background:#ef4444;color:white;">‚õî Stop Talking</button>

  <div id="reminder" style="margin:15px 0;font-weight:bold;color:#10b981;"></div>
  <div class="log" id="log"></div>
  <div id="storyArea"></div>
  <div id="timelineArea" style="display:none;margin-top:30px;"></div>

  <script>
    const SUPABASE_URL = 'https://zygetlpgjkpyiyjquhfp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5Z2V0bHBnamtweWl5anF1aGZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTk1NjcsImV4cCI6MjA4NjczNTU2N30.ZKb4tcjKGOU2XkRrEad3GxKLeRtKwdrdPlNwB9yvDeA';

    let supabaseClient = null;
    let currentUser = null;
    let entries = [];
    let recognition = null;
    let isConversing = false;
    let isAuthInProgress = false;
    const categories = ["Childhood","Family","Education","Career","Relationships","Adventures","Challenges","Reflections","Other"];

    function initSupabase() {
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          storage: localStorage,
          detectSessionInUrl: true
        }
      });

      supabaseClient.auth.onAuthStateChange(async (event, session) => {
        console.log('Auth event:', event, session ? 'session' : 'no session');
        currentUser = session?.user ?? null;
        if (currentUser) {
          document.getElementById('userStatus').textContent = `Logged in as ${currentUser.email}`;
          document.getElementById('clearSessionBtn').style.display = 'none';
          await loadEntries();
          dailyReminder();
        } else {
          document.getElementById('userStatus').textContent = 'Not logged in';
          document.getElementById('clearSessionBtn').style.display = 'inline-block';
        }
      });

      setTimeout(async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          currentUser = session.user;
          document.getElementById('userStatus').textContent = `Logged in as ${currentUser.email}`;
          await loadEntries();
        } else {
          document.getElementById('userStatus').textContent = 'Not logged in';
        }
      }, 800);
    }

    function logMessage(message) {
      console.log('LOG: ' + message);
      const logDiv = document.getElementById('log');
      const entryDiv = document.createElement('div');
      entryDiv.className = 'entry';
      entryDiv.textContent = `${new Date().toLocaleString()}: ${message}`;
      logDiv.appendChild(entryDiv);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function loadEntries() {
      if (!currentUser) return;
      const { data } = await supabaseClient.from('life_entries').select('*').eq('user_id', currentUser.id).order('timestamp', { ascending: false });
      entries = data || [];
    }

    async function addEntry(category, answer, question = null) {
      if (!currentUser) return;
      await supabaseClient.from('life_entries').insert({
        user_id: currentUser.id,
        category: category || 'Other',
        answer,
        question,
        timestamp: new Date().toISOString()
      });
      await loadEntries();
    }

    function initRecognition() {
      if (recognition) return;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        logMessage('Speech not supported in this browser.');
        return;
      }
      recognition = new SR();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onerror = e => {
        logMessage('Voice error: ' + e.error);
        if (e.error === 'no-speech' || e.error === 'aborted') {
          setTimeout(() => {
            if (recognition && !recognition.active) recognition.start();
          }, 800);
        }
      };

      recognition.onend = () => {
        if (isConversing) {
          setTimeout(() => {
            if (recognition && !recognition.active) recognition.start();
          }, 1000);
        }
      };
    }

    function speak(text) {
      if (!('speechSynthesis' in window)) {
        logMessage('Text-to-speech not supported in this browser.');
        return;
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;
      speechSynthesis.speak(utterance);
      logMessage('Speaking: ' + text);
    }

    async function callAI(prompt) {
      for (let attempt = 1; attempt <= 4; attempt++) {
        try {
          const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', { body: { prompt } });
          if (error) throw error;
          if (data.error) throw new Error(data.error.message);
          return data.choices[0].message.content.trim();
        } catch (error) {
          if (error.message.includes('429') && attempt < 4) {
            logMessage(`Rate limit ‚Äî waiting ${attempt * 10} seconds...`);
            await new Promise(r => setTimeout(r, attempt * 10000));
            continue;
          }
          throw error;
        }
      }
      throw new Error('Rate limit persistent');
    }

    async function letsTalk() {
      if (!currentUser) return logMessage('Must log in');
      isConversing = true;
      document.getElementById('stopTalk').style.display = 'inline-block';
      logMessage('Starting conversation...');
      await askNextQuestion();
    }

    async function askNextQuestion() {
      if (!isConversing) return;
      const summaries = entries.map(e => (e.question ? e.question + ': ' : '') + (e.answer || '')).join('\n');
      const prompt = `From these entries: ${summaries || 'None yet'}\nAsk one very short question (max 12 words). Be warm. Question only.`;

      try {
        const question = await callAI(prompt);
        logMessage(`Question: ${question}`);
        speak(question);

        initRecognition();
        if (!recognition) return;

        recognition.onresult = async e => {
          let text = '';
          for (let i = e.resultIndex; i < e.results.length; i++) {
            text += e.results[i][0].transcript;
          }
          if (text.trim()) {
            logMessage(`You said: ${text}`);
            await addEntry('Other', text, question);
            recognition.stop();
            setTimeout(askNextQuestion, 10000);
          }
        };

        if (!recognition.active) {
          recognition.start();
          logMessage('Listening...');
        } else {
          logMessage('Already listening...');
        }
      } catch (e) {
        logMessage('AI temporarily unavailable ‚Äî try again later.');
        stopConversation();
      }
    }

    function stopConversation() {
      isConversing = false;
      document.getElementById('stopTalk').style.display = 'none';
      if (recognition) recognition.abort();
      speak('Conversation ended. Thanks!');
      logMessage('Conversation ended');
    }

    function dailyReminder() {
      document.getElementById('reminder').textContent = "Don't forget to add to your life story today!";
    }

    // Placeholder for other functions (add them back if needed)
    function newVoiceMemo() { logMessage('Voice memo feature coming soon'); }
    function typeEntry() { logMessage('Typed entry feature coming soon'); }
    function generateStory() { logMessage('Story generation coming soon'); }
    function continueStory() { logMessage('Continue story coming soon'); }
    function showChronologicalRecord() { logMessage('Chronological record coming soon'); }
    function clearMyData() { logMessage('Data clear coming soon'); }

    initSupabase();
  </script>
</body>
</html>