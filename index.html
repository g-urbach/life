<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Life Story</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    button { padding: 12px 20px; margin: 6px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    .primary { background: #10b981; color: white; }
    .secondary { background: #3b82f6; color: white; }
    .entry { border: 1px solid #e2e8f0; padding: 16px; margin-bottom: 16px; border-radius: 8px; background: #f8fafc; }
    .story { white-space: pre-wrap; background: #f1f5f9; padding: 20px; border-radius: 8px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>‚ù§Ô∏è My Life Story</h1>
  <p><strong>Share this page with your family ‚Äî they only need their email + password.</strong></p>

  <!-- Auth -->
  <div style="background:#f0f9ff;padding:15px;border-radius:8px;margin:20px 0;">
    <input id="email" placeholder="Email" style="width:48%;padding:8px;">
    <input id="password" type="password" placeholder="Password" style="width:48%;padding:8px;">
    <button onclick="signUp()" class="secondary">Sign Up</button>
    <button onclick="signIn()" class="primary">Sign In</button>
    <button onclick="signOut()" class="secondary">Sign Out</button>
    <span id="userStatus" style="margin-left:15px;font-weight:bold;"></span>
  </div>

  <button onclick="letsTalk()" class="primary">Lets talk :)</button>
  <button onclick="newVoiceMemo()">üéôÔ∏è New Voice Memo</button>
  <button onclick="typeEntry()">‚å®Ô∏è New Typed Entry</button>
  <button onclick="generateStory()">üìñ Generate My Story</button>
  <button onclick="continueStory()">üîÑ Continue My Story</button>
  <button onclick="showChronologicalRecord()">üìã Chronological Record</button>
  <button onclick="clearMyData()" style="background:#ef4444;color:white;">Delete My Data</button>
  <button id="stopTalk" onclick="stopConversation()" style="display:none;background:#ef4444;color:white;">‚õî Stop Talking</button>

  <div id="reminder" style="margin:15px 0;font-weight:bold;color:#10b981;"></div>
  <div class="log" id="log"></div>
  <div id="storyArea"></div>
  <div id="timelineArea" style="display:none;margin-top:30px;"></div>

  <script>
    // === REPLACE THESE WITH YOUR REAL VALUES ===
    const SUPABASE_URL = 'https://zygetlpgjkpyiyjquhfp.supabase.co';      // ‚Üê from Supabase Settings ‚Üí API
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5Z2V0bHBnamtweWl5anF1aGZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTk1NjcsImV4cCI6MjA4NjczNTU2N30.ZKb4tcjKGOU2XkRrEad3GxKLeRtKwdrdPlNwB9yvDeA';                     // ‚Üê anon public key

    let supabaseClient = null;
    let currentUser = null;
    let entries = [];
    let recognition = null;
    let isConversing = false;
    const categories = ["Childhood","Family","Education","Career","Relationships","Adventures","Challenges","Reflections","Other"];

    function initSupabase() {
      if (!SUPABASE_URL.includes('supabase.co') || SUPABASE_ANON_KEY.length < 50) {
        alert('Please replace the SUPABASE_URL and SUPABASE_ANON_KEY at the top of the code!');
        return;
      }
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      checkAuth();
    }

    function logMessage(message) {
      const logDiv = document.getElementById('log');
      const entryDiv = document.createElement('div');
      entryDiv.className = 'entry';
      entryDiv.textContent = `${new Date().toLocaleString()}: ${message}`;
      logDiv.appendChild(entryDiv);
      logDiv.scrollTop = logDiv.scrollHeight; // Auto-scroll to bottom
    }

    async function checkAuth() {
      logMessage('Checking authentication status');
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      if (error) {
        logMessage('Error checking auth: ' + error.message);
        return;
      }
      currentUser = user;
      if (user) {
        document.getElementById('userStatus').textContent = `Logged in as ${user.email}`;
        logMessage('User authenticated');
        await loadEntries();
        dailyReminder();
      } else {
        document.getElementById('userStatus').textContent = 'Not logged in';
        entries = [];
        document.getElementById('log').innerHTML = '';
        document.getElementById('storyArea').innerHTML = '';
        document.getElementById('timelineArea').style.display = 'none';
        logMessage('No user authenticated');
      }
    }

    async function signUp() {
      logMessage('Starting sign up');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) {
        logMessage('Email or password missing');
        return;
      }
      try {
        const { data, error } = await supabaseClient.auth.signUp({ email, password });
        if (error) throw error;
        logMessage('Sign up successful. Check your email for verification link.');
      } catch (error) {
        logMessage('Sign up error: ' + error.message);
      }
    }

    async function signIn() {
      logMessage('Starting sign in');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) {
        logMessage('Email or password missing');
        return;
      }
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;
        currentUser = data.user;
        logMessage('Sign in successful');
        await checkAuth();
      } catch (error) {
        logMessage('Sign in error: ' + error.message);
      }
    }

    async function signOut() {
      logMessage('Starting sign out');
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        currentUser = null;
        logMessage('Signed out successfully');
        await checkAuth();
      } catch (error) {
        logMessage('Sign out error: ' + error.message);
      }
    }

    async function loadEntries() {
      if (!currentUser) return;
      logMessage('Loading entries');
      try {
        const { data, error } = await supabaseClient.from('life_entries').select('*').eq('user_id', currentUser.id).order('timestamp', { ascending: false });
        if (error) throw error;
        entries = data;
        logMessage(`Loaded ${entries.length} entries`);
        displayEntries();
      } catch (error) {
        logMessage('Error loading entries: ' + error.message + ' (Check if table exists and RLS is set up in Supabase)');
      }
    }

    function displayEntries() {
      const logDiv = document.getElementById('log');
      logDiv.innerHTML = ''; // Clear previous content
      entries.forEach(entry => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'entry';
        let content = `<strong>${entry.category || 'Other'}</strong> (${new Date(entry.timestamp).toLocaleDateString()})<br>`;
        if (entry.question) content += `<em>Question: ${entry.question}</em><br>`;
        content += `${entry.answer || ''}`;
        if (entry.photo) content += `<br>Photo: ${entry.photo}`;
        if (entry.audio) content += `<br>Audio: ${entry.audio}`;
        entryDiv.innerHTML = content;
        logDiv.appendChild(entryDiv);
      });
    }

    async function addEntry(category, answer, question = null, photo = null, audio = null) {
      if (!currentUser) return logMessage('Must be logged in to add entry');
      logMessage('Adding new entry');
      const insertData = {
        user_id: currentUser.id,
        category: category || 'Other',
        answer: answer,
        question: question,
        photo: photo,
        audio: audio
      };
      const { error } = await supabaseClient.from('life_entries').insert(insertData);
      if (error) {
        logMessage('Error adding entry: ' + error.message);
      } else {
        logMessage('Entry added successfully');
        await loadEntries();
      }
    }

    function initRecognition() {
      if (recognition) return;
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        logMessage('Speech recognition not supported in this browser. Try Chrome.');
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = true;     // ‚Üê Show live partial results
      recognition.continuous = true;         // ‚Üê Keep listening across pauses
      recognition.maxAlternatives = 1;

      // Improved error & event logging for debugging
      recognition.onerror = (event) => {
        logMessage('Recognition error: ' + event.error);  // e.g. 'no-speech', 'not-allowed', 'network'
        if (event.error === 'no-speech' || event.error === 'aborted') {
          // Auto-restart on silence timeout
          if (isConversing) {
            logMessage('Silence detected ‚Äî restarting listening...');
            setTimeout(() => recognition.start(), 500); // short delay to avoid loops
          }
        }
      };

      recognition.onend = () => {
        logMessage('Voice recognition ended');
        if (isConversing) {
          logMessage('Restarting listening...');
          setTimeout(() => recognition.start(), 800); // natural pause + prevent crash loops
        }
      };

      recognition.onspeechend = () => logMessage('Detected end of speech (pause)');
      recognition.onaudioend = () => logMessage('Audio input stopped');
      recognition.onnomatch = () => logMessage('No clear speech match');
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        speechSynthesis.speak(utterance);
      } else {
        logMessage('Speech synthesis not supported');
      }
    }

    async function callGemini(prompt) {
      const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
        body: { prompt }
      });
      if (error) {
        logMessage('Gemini error: ' + error.message);
        throw error;
      }
      return data;
    }

    async function letsTalk() {
      if (!currentUser) return logMessage('Must be logged in');
      isConversing = true;
      document.getElementById('stopTalk').style.display = 'inline-block';
      logMessage('Starting conversation...');
      await askNextQuestion();
    }

    async function askNextQuestion() {
      if (!isConversing) return;

      const entrySummaries = entries.map(e => (e.question ? e.question + ': ' : '') + (e.answer || '')).join('\n');
      const geminiPrompt = `Based on these life story entries: ${entrySummaries || 'No previous entries'}\nGenerate one thoughtful question to elicit more details about the person's life. If dates are missing for experiences, ask for them. Also explore life philosophies, values, lessons learned. Question only. Be warm and conversational.`;

      try {
        const data = await callGemini(geminiPrompt);
        const question = data.candidates[0].content.parts[0].text.trim();
        logMessage(`Question: ${question}`);
        speak(question);

        initRecognition();
        if (!recognition) return;

        // Attach result handler once per question (or move outside if you prefer global)
        recognition.onresult = async (event) => {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            transcript += event.results[i][0].transcript;
          }
          if (transcript.trim()) {
            logMessage(`You said: ${transcript}`);
            await addEntry('Other', transcript, question);
            // Optional: Stop after good answer, ask next question after short delay
            recognition.stop(); // pause to process
            setTimeout(askNextQuestion, 1500); // give breathing room before next AI question
          }
        };

        recognition.start();
        logMessage('Listening... (speak now ‚Äî it stays open longer)');
      } catch (error) {
        logMessage('Error generating question: ' + error.message);
        stopConversation();
      }
    }

    function stopConversation() {
      isConversing = false;
      document.getElementById('stopTalk').style.display = 'none';
      if (recognition) {
        recognition.stop();
        recognition.abort(); // force clean stop
      }
      speak('Conversation ended. Thanks for sharing!');
      logMessage('Conversation ended');
    }

    function newVoiceMemo() {
      if (!currentUser) return logMessage('Must be logged in');
      initRecognition();
      if (!recognition) return;
      recognition.onresult = event => {
        const answer = event.results[0][0].transcript;
        logMessage(`Voice memo: ${answer}`);
        const category = prompt('Category: ' + categories.join(', ')) || 'Other';
        addEntry(category, answer);
      };
      recognition.start();
      logMessage('Listening for memo...');
    }

    function typeEntry() {
      if (!currentUser) return logMessage('Must be logged in');
      const category = prompt('Category: ' + categories.join(', ')) || 'Other';
      const answer = prompt('Enter text:');
      if (answer) addEntry(category, answer);
    }

    async function generateStory() {
      if (!currentUser) return logMessage('Must be logged in');
      if (entries.length === 0) return logMessage('No entries');
      document.getElementById('timelineArea').style.display = 'none';
      logMessage('Generating story');
      const categorizedEntries = categories.map(cat => {
        const catTexts = entries.filter(e => e.category === cat).map(e => (e.question ? e.question + ': ' : '') + (e.answer || '')).join('\n');
        return catTexts ? `${cat}:\n${catTexts}` : '';
      }).filter(Boolean).join('\n\n');
      const geminiPrompt = `Create a cohesive, engaging narrative life story from these categorized entries. Use first-person perspective:\n${categorizedEntries}`;
      try {
        const data = await callGemini(geminiPrompt);
        const story = data.candidates[0].content.parts[0].text;
        document.getElementById('storyArea').innerHTML = `<div class="story"><h2>My Life Story</h2><pre>${story}</pre></div>`;
        logMessage('Story generated');
      } catch (error) {
        logMessage('Error generating story: ' + error.message);
      }
    }

    async function continueStory() {
      if (!currentUser) return logMessage('Must be logged in');
      const storyDiv = document.getElementById('storyArea');
      const currentStory = storyDiv.textContent.trim();
      if (!currentStory) return logMessage('Generate story first');
      document.getElementById('timelineArea').style.display = 'none';
      logMessage('Continuing story');
      const geminiPrompt = `Continue this life story cohesively. Add details or chapters based on entries: ${currentStory}`;
      try {
        const data = await callGemini(geminiPrompt);
        const continuation = data.candidates[0].content.parts[0].text;
        storyDiv.innerHTML = `<div class="story"><h2>My Life Story (Continued)</h2><pre>${currentStory}\n\n${continuation}</pre></div>`;
        logMessage('Story continued');
      } catch (error) {
        logMessage('Error continuing story: ' + error.message);
      }
    }

    function showChronologicalRecord() {
      document.getElementById('storyArea').innerHTML = '';
      const area = document.getElementById('timelineArea');
      area.style.display = 'block';
      const sorted = [...entries].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      let html = '<h2>üìã Chronological Record</h2>';
      sorted.forEach(entry => {
        const date = new Date(entry.timestamp).toLocaleString();
        html += `<div class="entry"><strong>${date}</strong> - <strong>${entry.category || 'Other'}</strong><br>`;
        if (entry.question) html += `<em>Question: ${entry.question}</em><br>`;
        html += `${entry.answer || ''}</div>`;
      });
      area.innerHTML = html;
    }

    async function clearMyData() {
      if (!currentUser) return logMessage('Must be logged in');
      if (!confirm('Sure? This deletes everything permanently.')) return;
      logMessage('Deleting data');
      const { error } = await supabaseClient.from('life_entries').delete().eq('user_id', currentUser.id);
      if (error) {
        logMessage('Error deleting: ' + error.message);
      } else {
        logMessage('Data deleted');
        await loadEntries();
      }
    }

    function dailyReminder() {
      document.getElementById('reminder').textContent = "Don't forget to add to your life story today!";
    }

    // Init
    initSupabase();
    supabaseClient.auth.onAuthStateChange((event, session) => {
      logMessage(`Auth changed: ${event}`);
      checkAuth();
    });
  </script>
</body>
</html>